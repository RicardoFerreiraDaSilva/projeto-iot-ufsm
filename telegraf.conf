# ==============================================================================
# 1. Agente (Agent)
# Define o comportamento do Telegraf
# ==============================================================================
[agent]
  interval = "10s" # Coleta a cada 10 segundos
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  hostname = "telegraf-agent"
  omit_hostname = false

# ==============================================================================
# 2. Entrada (Input Plugin) - Consumidor MQTT
# O Telegraf se inscreve nos tópicos do Mosquitto
# ==============================================================================
[[inputs.mqtt_consumer]]
  # Endereço do broker (nome do container na rede Docker)
  servers = ["tcp://mosquitto:1883"] 

  # Tópicos para escutar. Exemplo: sensores/sala/json, sensores/quarto/json
  topics = [
    "sensores/+/json" 
  ]

  # Especifica que o payload da mensagem é JSON
  data_format = "json" 
  
  # Este plugin pega o campo 'dispositivo_id' do JSON e o transforma em uma TAG
  # As TAGS são usadas para indexação e filtragem no InfluxDB.
  tag_keys = ["dispositivo_id"] 

# ==============================================================================
# 3. Saída (Output Plugin) - InfluxDB v2
# Envia os dados para o InfluxDB
# ==============================================================================
[[outputs.influxdb_v2]]
  # URL do InfluxDB (nome do container na rede Docker)
  urls = ["$INFLUXDB_URL"] 
  
  # O Token de API para autenticação, lido da variável de ambiente no docker-compose
  token = "$INFLUX_TOKEN" 

  # A organização e o bucket, lidos das variáveis de ambiente
  organization = "$INFLUXDB_ORG"
  bucket = "$INFLUXDB_BUCKET"